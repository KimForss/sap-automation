# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# /*---------------------------------------------------------------------------8
# |                                                                            |
# |                Relocate TempDB to Configured Mount Points                  |
# |                                                                            |
# +------------------------------------4--------------------------------------*/

---

- name:                                "WIN-SQL: Ensure Run Flag Directory exists"
  ansible.windows.win_file:
    path:                              '{{ sap_deployment_automation }}\{{ sap_sid | upper }}'
    state:                             directory

- name:                                "WIN-SQL: Check if TempDB relocation already performed"
  ansible.windows.win_stat:
    path:                              '{{ sap_deployment_automation }}\{{ sap_sid | upper }}\sap_deployment_tempdb_relocated.txt'
  register:                            tempdb_relocated

- name:                                "WIN-SQL: TempDB status"
  ansible.builtin.debug:
    msg:                               "WIN-SQL: TempDB already relocated to mount points"
  when:
    - tempdb_relocated.stat.exists

- name:                                "WIN-SQL: Relocate TempDB"
  when:
    - not tempdb_relocated.stat.exists
  block:

    - name:                            "WIN-SQL: Validate volume_groups configuration"
      ansible.builtin.assert:
        that:
          - volume_groups is defined
          - volume_groups | length > 0
          - volume_groups | selectattr('disk_type', 'equalto', 'tempdb') | list | length > 0
        fail_msg:                      "volume_groups must be configured with tempdb disks"

    - name:                            "WIN-SQL: Get TempDB disks from volume_groups"
      ansible.builtin.set_fact:
        tempdb_disks:                  "{{ volume_groups | selectattr('disk_type', 'equalto', 'tempdb') | list }}"

    - name:                            "WIN-SQL: Display TempDB configuration"
      ansible.builtin.debug:
        msg:
          - "TempDB disks found: {{ tempdb_disks | length }}"
          - "Configuration: {{ tempdb_disks | map(attribute='diskname') | list }}"

    - name:                            "WIN-SQL: Query current TempDB file locations"
      ansible.windows.win_shell: |
                                       $ErrorActionPreference = 'Stop'
                                       Import-Module SqlServer -ErrorAction SilentlyContinue
                                       $query = @"
                                       SELECT 
                                           name,
                                           physical_name,
                                           type_desc,
                                           size * 8 / 1024 AS size_mb
                                       FROM sys.master_files
                                       WHERE database_id = 2
                                       ORDER BY type, file_id
                                       "@
                                       Invoke-Sqlcmd -Query $query -TrustServerCertificate | ConvertTo-Json
      register:                        current_tempdb_files
      changed_when:                    false

    - name:                            "WIN-SQL: Parse current TempDB files"
      ansible.builtin.set_fact:
        current_tempdb_info:           "{{ current_tempdb_files.stdout | from_json }}"

    - name:                            "WIN-SQL: Display current TempDB locations"
      ansible.builtin.debug:
        msg:                           "Current TempDB files: {{ current_tempdb_info | map(attribute='physical_name') | list }}"

    - name:                            "WIN-SQL: Generate TempDB relocation script"
      ansible.windows.win_tempfile:
        state:                         file
        suffix:                        .sql
      register:                        tempdb_relocation_script

    - name:                            "WIN-SQL: Build TempDB ALTER DATABASE statements"
      ansible.builtin.set_fact:
        tempdb_alter_statements:       "{{ tempdb_alter_statements | default([]) + [item] }}"
      loop:                            "{{ lookup('template', 'tempdb_relocation.j2').split('\n') }}"
      when:                            item | trim | length > 0

    - name:                            "WIN-SQL: Write TempDB relocation SQL"
      ansible.windows.win_copy:
        content:                       "{{ tempdb_alter_statements | join('\n') }}"
        dest:                          "{{ tempdb_relocation_script.path }}"

    - name:                            "WIN-SQL: Display relocation plan"
      ansible.builtin.debug:
        msg:
          - "SQL script: {{ tempdb_relocation_script.path }}"
          - "Data files: {{ tempdb_disks | length }}"
          - "Log file: {{ tempdb_disks[0].mount_point if tempdb_disks | length > 0 else 'C:\\SQLServer\\TEMPDB\\TEMPDB1' }}"

    - name:                            "WIN-SQL: Execute TempDB relocation"
      ansible.windows.win_shell: |
                                       $ErrorActionPreference = 'Stop'
                                       Import-Module SqlServer -ErrorAction SilentlyContinue
                                       Invoke-Sqlcmd -InputFile "{{ tempdb_relocation_script.path }}" -TrustServerCertificate
      register:                        tempdb_relocation_result
      failed_when:                     tempdb_relocation_result.rc != 0

    - name:                            "WIN-SQL: Restart SQL Server service"
      ansible.windows.win_service:
        name:                          MSSQLSERVER
        state:                         restarted
        force_dependent_services:      true
      register:                        sql_restart_result

    - name:                            "WIN-SQL: Wait for SQL Server to be ready"
      ansible.windows.win_shell: |
                                       $ErrorActionPreference = 'Stop'
                                       Import-Module SqlServer -ErrorAction SilentlyContinue
                                       $timeout = 120
                                       $elapsed = 0
                                       while ($elapsed -lt $timeout) {
                                           try {
                                               Invoke-Sqlcmd -Query "SELECT 1" -TrustServerCertificate -ErrorAction Stop
                                               exit 0
                                           }
                                           catch {
                                               Start-Sleep -Seconds 5
                                               $elapsed += 5
                                           }
                                       }
                                       throw "SQL Server did not become ready within $timeout seconds"
      register:                        sql_ready_check
      changed_when:                    false

    - name:                            "WIN-SQL: Verify TempDB new locations"
      ansible.windows.win_shell: |
                                       $ErrorActionPreference = 'Stop'
                                       Import-Module SqlServer -ErrorAction SilentlyContinue
                                       $query = @"
                                       SELECT 
                                           name,
                                           physical_name,
                                           type_desc
                                       FROM sys.master_files
                                       WHERE database_id = 2
                                       ORDER BY type, file_id
                                       "@
                                       Invoke-Sqlcmd -Query $query -TrustServerCertificate | ConvertTo-Json
      register:                        new_tempdb_files
      changed_when:                    false

    - name:                            "WIN-SQL: Display new TempDB locations"
      ansible.builtin.debug:
        msg:                           "New TempDB files: {{ (new_tempdb_files.stdout | from_json) | map(attribute='physical_name') | list }}"

    - name:                            "WIN-SQL: Clean up SQL script"
      ansible.windows.win_file:
        path:                          "{{ tempdb_relocation_script.path }}"
        state:                         absent

    - name:                            "WIN-SQL: Set TempDB relocation flag"
      ansible.windows.win_file:
        path:                          '{{ sap_deployment_automation }}\{{ sap_sid | upper }}\sap_deployment_tempdb_relocated.txt'
        state:                         touch
      when:
        - sql_restart_result is defined
        - sql_ready_check.rc == 0

...
