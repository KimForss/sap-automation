# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# /*---------------------------------------------------------------------------8
# |                                                                            |
# |                Perform DB Creation using PowerShell                        |
# |                                                                            |
# +------------------------------------4--------------------------------------*/

- name:                                 "WIN-SQL: Ensure Run Flag Directory is Existing"
  ansible.windows.win_file:
    path:                               '{{ sap_deployment_automation }}\{{ sap_sid | upper }}'
    state:                              directory

- name:                                 "WIN-SQL: Check if DB is already existing"
  ansible.windows.win_stat:
    path:                               '{{ sap_deployment_automation }}\{{ sap_sid | upper }}\sap_deployment_sqldb_create.txt'
  register:                             db_creation

- name:                                 "WIN-SQL: DB status"
  ansible.builtin.debug:
    msg:                                "WIN-SQL: DB is already existing"
  when:
    - db_creation.stat.exists

- name:                                 "WIN-SQL: Validate volume_groups configuration"
  ansible.builtin.assert:
    that:
      - volume_groups is defined
      - volume_groups | length > 0
      - volume_groups | selectattr('disk_type', 'equalto', 'data') | list | length > 0
      - volume_groups | selectattr('disk_type', 'equalto', 'log') | list | length > 0
    fail_msg:                           "volume_groups must be configured with data and log disks"
  when:
    - not db_creation.stat.exists

- name:                                 "WIN-SQL: Generate database creation SQL script"
  ansible.windows.win_tempfile:
    state:                              file
    suffix:                             .sql
  register:                             db_creation_script
  when:
    - not db_creation.stat.exists

- name:                                 "WIN-SQL: Render database creation SQL"
  ansible.windows.win_copy:
    content:                            "{{ lookup('template', 'MYSQL_v1_DB_Creation.j2') }}"
    dest:                               "{{ db_creation_script.path }}"
  when:
    - not db_creation.stat.exists

- name:                                 "WIN-SQL: Create database {{ db_sid | upper }}"
  ansible.windows.win_shell: |
                                        $ErrorActionPreference = 'Stop'
                                        Import-Module SqlServer -ErrorAction SilentlyContinue
                                        Invoke-Sqlcmd -InputFile "{{ db_creation_script.path }}" -TrustServerCertificate
  args:
    creates:                            '{{ sap_deployment_automation }}\{{ sap_sid | upper }}\sap_deployment_sqldb_create.txt'
  register:                             sql_output
  failed_when:                          sql_output.rc != 0
  become:                               true
  become_method:                        ansible.builtin.runas
  become_user:                          '{{ sap_sid }}adm@{{ domain_name }}'
  vars:
    ansible_become_password:            "{{ domain_user_password }}"
  when:
    - not db_creation.stat.exists

- name:                                 "WIN-SQL: Clean up SQL script"
  ansible.windows.win_file:
    path:                               "{{ db_creation_script.path }}"
    state:                              absent
  when:
    - db_creation_script.path is defined

- name:                                 "WIN-SQL: DB Creation || Flag File"
  ansible.windows.win_file:
    path:                               '{{ sap_deployment_automation }}\{{ sap_sid | upper }}\sap_deployment_sqldb_create.txt'
    state:                              touch
  when:
    - sql_output.rc is defined
    - sql_output.rc == 0
