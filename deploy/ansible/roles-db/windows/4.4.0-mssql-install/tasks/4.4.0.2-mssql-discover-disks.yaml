# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# /*---------------------------------------------------------------------------8
# |                                                                            |
# |          Discover Disk Configuration and Reconstruct volume_groups        |
# |          Self-contained: Works even if 1.5-disk-setup never ran           |
# |          Idempotent: Discovers current state from Windows system          |
# |                                                                            |
# +------------------------------------4--------------------------------------*/

---

- name: "Disk Discovery: Check if volume_groups already available"
  ansible.builtin.debug:
    msg: "volume_groups already defined ({{ volume_groups | length }} disks)"
  when: (volume_groups is defined) and (volume_groups | length > 0)

- name: "Disk Discovery: Query mount points and volumes"
  ansible.windows.win_powershell:
    script: |
        $ErrorActionPreference = "Stop"

        $volumes = Get-Volume | Where-Object {
            $_.DriveLetter -ne $null -or $_.Path -ne $null
        } | Select-Object @{
            Name       = "DriveLetter";
            Expression = { if ($_.DriveLetter) { $_.DriveLetter.ToString() } else { $null } }
        }, @{
            Name       = "Path";
            Expression = { $_.Path }
        }, @{
            Name       = "FileSystemLabel";
            Expression = { $_.FileSystemLabel }
        }, @{
            Name       = "Size";
            Expression = { $_.Size }
        } | Where-Object { $_.FileSystemLabel -ne "" }

        $partitions = Get-Partition | Select-Object DiskNumber, DriveLetter, AccessPaths, @{
            Name       = "MountPoint";
            Expression = {
                $accessPaths = $_.AccessPaths | Where-Object { $_ -notmatch "^[A-Z]:\\$" }
                if ($accessPaths) { $accessPaths[0].TrimEnd("\") } else { $null }
            }
        } | Where-Object { $_.AccessPaths -ne $null }

        $disks = Get-Disk | Where-Object { -not $_.IsBoot } | Select-Object Number, @{
            Name       = "LUN";
            Expression = {
                if ($_.Location -match "LUN\s+(\d+)") { [int]$Matches[1] } else { $null }
            }
        }, UniqueId, PartitionStyle

        $result = @()
        foreach ($disk in $disks) {
            $partition = $partitions | Where-Object { $_.DiskNumber -eq $disk.Number } | Select-Object -First 1
            if ($partition) {
                $volume = $volumes | Where-Object {
                    ($partition.AccessPaths -contains $_.Path) -or
                    ($_.DriveLetter -and $_.DriveLetter -eq $partition.DriveLetter) -or
                    ($partition.MountPoint -and $_.Path -like "*$($partition.MountPoint)*")
                } | Select-Object -First 1
                $result += [PSCustomObject]@{
                    LUN            = $disk.LUN
                    DiskNumber     = $disk.Number
                    UniqueId       = $disk.UniqueId
                    PartitionStyle = $disk.PartitionStyle
                    DriveLetter    = $partition.DriveLetter
                    MountPoint     = $partition.MountPoint
                    Label          = if ($volume) { $volume.FileSystemLabel } else { $null }
                    SizeGB         = if ($volume) { [math]::Round($volume.Size / 1GB, 2) } else { 0 }
                }
            }
        }

        $result | ConvertTo-Json -Depth 3
  register: discovered_disks_raw
  changed_when: false
  when: (volume_groups is not defined) or (volume_groups | length == 0)

- name: "Disk Discovery: Parse discovered disks"
  ansible.builtin.set_fact:
    discovered_disks: "{{ discovered_disks_raw.stdout | from_json if discovered_disks_raw.stdout | length > 0 else [] }}"
  when:
    - (volume_groups is not defined) or (volume_groups | length == 0)
    - discovered_disks_raw is defined

- name: "Disk Discovery: Display discovered disk configuration"
  ansible.builtin.debug:
    msg:
      - "Discovered {{ discovered_disks | length }} data disks"
      - "Mount strategy: {{ disk_mount_strategy }}"
      - "Base path: {{ disk_base_mount_path if disk_mount_strategy == 'mountpoint' else 'N/A (drive letters)' }}"
  when:
    - (volume_groups is not defined) or (volume_groups | length == 0)
    - discovered_disks is defined

- name: "Disk Discovery: Reconstruct volume_groups from discovered state"
  ansible.builtin.set_fact:
    volume_groups: "{{ lookup('template', 'volume_groups_from_discovery.j2') | from_yaml }}"
  vars:
    discovered_disks_list: "{{ discovered_disks }}"
    mount_strategy: "{{ disk_mount_strategy }}"
    base_mount_path: "{{ disk_base_mount_path }}"
  when:
    - (volume_groups is not defined) or (volume_groups | length == 0)
    - discovered_disks is defined
    - discovered_disks | length > 0

- name: "Disk Discovery: Validate reconstructed volume_groups"
  ansible.builtin.assert:
    that:
      - volume_groups is defined
      - volume_groups | length > 0
    fail_msg: |
      Failed to discover or reconstruct volume_groups.
      Possible causes:
      - No data disks attached to system
      - Disks not initialized/formatted
      - Mount points not created

      Manual intervention required:
      1. Verify disks are attached via Azure Portal
      2. Run 1.5-disk-setup role to initialize disks
      3. Or manually configure disks per documentation
  when: volume_groups is defined

- name: "Disk Discovery: Display volume_groups summary"
  ansible.builtin.debug:
    msg:
      - "Volume groups available: {{ volume_groups | length }}"
      - "Disk types: {{ volume_groups | map(attribute='disk_type') | unique | list }}"
      - "Data disks: {{ volume_groups | selectattr('disk_type', 'equalto', 'data') | list | length }}"
      - "Log disks: {{ volume_groups | selectattr('disk_type', 'equalto', 'log') | list | length }}"
      - "TempDB disks: {{ volume_groups | selectattr('disk_type', 'equalto', 'tempdb') | list | length }}"
      - "Backup disks: {{ volume_groups | selectattr('disk_type', 'equalto', 'backup') | list | length }}"
      - "SAP disks: {{ volume_groups | selectattr('disk_type', 'equalto', 'sap') | list | length }}"
      - "Mount strategy: {{ 'Mount Points' if (volume_groups | selectattr('use_mount_point', 'equalto', true) | list | length > 0) else 'Drive Letters' }}"

...
