{# Copyright (c) Microsoft Corporation.
 # Licensed under the MIT License.
#}
{#
 # Windows Disk Volume Groups Configuration Template
 #
 # Purpose: Transform Azure disk configuration into Windows disk configuration
 #          without filtering by partition style (for idempotency)
 #
 # Key Changes from Original:
 # - Does NOT filter by partition_style='RAW' (allows recovery of partial configs)
 # - Maps ALL disks defined in inventory, regardless of current state
 # - SAP disk ALWAYS uses S:\ drive letter (never mount point)
 # - Adds state tracking fields for runtime decision making
 #
 # Variables:
 # - disk_mount_strategy: 'driveletter' or 'mountpoint' (default: 'driveletter')
 # - disk_base_mount_path: Base path for mount points (default: 'C:\SQLServerDisks')
 # - sbd_luns: List of LUNs to exclude (Azure Shared Disks for STONITH)
#}
{% set vgs = [] %}
{#
    Initialize counters and common variables
#}
{%     set startletter = namespace(value=101) %}
{%     set data_disk_counter = namespace(value=0) %}
{%     set log_disk_counter = namespace(value=0) %}
{%     set tempdb_disk_counter = namespace(value=0) %}
{%     set backup_disk_counter = namespace(value=0) %}
{%     set pvlist = [] %}
{%     set use_mount_point = disk_mount_strategy | default('driveletter') == 'mountpoint' %}
{%     set base_mount_path = disk_base_mount_path | default('C:\\SQLServerDisks') %}
{%     set sbd_luns_list = sbd_luns | default([]) %}
{#
    Outer Loop: Loop over disk types
#}
{% for disktype in disktypes %}
{#
    Initialize VG dictionary with VG name derived from disk type
#}
{%     set size = 4096 %}
{% if disktype == 'data' %}
{%     set size = 65536 %}
{% elif disktype == 'log' %}
{%     set size = 65536 %}
{% elif disktype == 'tempdb' %}
{%     set size = 65536 %}
{% endif %}
{%     set vg = {'disktype': disktype} %}
{#
    Inner Loop: Loop over list of disks that match the execution host and the disk type
    Exclude SBD devices (Azure Shared Disks used for STONITH in HA configurations)
#}
{%     for disk in disks if (disk.host == inventory_hostname) and (disk.type == disktype) and (disk.LUN not in sbd_luns_list) %}
{%     set startletter.value = startletter.value + 1 %}
{%     set regex_string = '^Integrated.+LUN\s('~ disk.LUN ~ ')$' %}
{#
    Determine drive letter configuration based on disk type
#}
{% if disktype == 'sap' %}
{%     set startlettercharacter = "S" %}
{%     set mount_folder_name = "SAP" %}
{%     set mount_base_path_type = base_mount_path ~ "\\SAP" %}
{% elif disktype == 'log' %}
{%     set log_disk_counter.value = log_disk_counter.value + 1 %}
{%     set startlettercharacter = "N" %}
{%     set mount_folder_name = "LOG" ~ log_disk_counter.value %}
{%     set mount_base_path_type = base_mount_path ~ "\\LOG" %}
{% elif disktype == 'data' %}
{%     set data_disk_counter.value = data_disk_counter.value + 1 %}
{%     set startlettercharacter = "abcdefghijklmnopqrstuvwxyz"[startletter.value - 97] | upper %}
{%     set mount_folder_name = "DATA" ~ data_disk_counter.value %}
{%     set mount_base_path_type = base_mount_path ~ "\\DATA" %}
{% elif disktype == 'backup' %}
{%     set backup_disk_counter.value = backup_disk_counter.value + 1 %}
{%     set startlettercharacter = "T" %}
{%     set mount_folder_name = "BACKUP" ~ backup_disk_counter.value %}
{%     set mount_base_path_type = base_mount_path ~ "\\BACKUP" %}
{% elif disktype == 'tempdb' %}
{%     set tempdb_disk_counter.value = tempdb_disk_counter.value + 1 %}
{%     set startlettercharacter = "abcdefghijklmnopqrstuvwxyz"[startletter.value - 117] | upper %}
{%     set mount_folder_name = "TEMPDB" ~ tempdb_disk_counter.value %}
{%     set mount_base_path_type = base_mount_path ~ "\\TEMPDB" %}
{% else %}
{%     set startlettercharacter = "V" %}
{%     set mount_folder_name = disktype | upper ~ loop.index %}
{%     set mount_base_path_type = base_mount_path ~ "\\" ~ disktype | upper %}
{% endif %}
{#
    Disk Matching: Use filter chain pattern from existing template
    1. Exclude bootable disk (OS disk)
    2. Exclude Azure temporary disk by partition style heuristic:
       - Azure managed disks: Initially RAW, or GPT if previously initialized
       - Azure temporary disk: Pre-provisioned as MBR with partition
       - Strategy: Accept RAW or GPT only (excludes pre-existing MBR temp disk)
    3. Match by location (Azure LUN mapping)

    This maintains idempotency:
    - RAW disks: Will be initialized
    - GPT disks: Already initialized by us, will be recovered/verified
    - MBR disks: Assumed to be Azure temp disk, excluded

    Returns undefined if no match (handled with default)
#}
{%     set matched_disk = ansible_facts.disks
         | rejectattr('bootable', 'equalto', true)
         | selectattr('partition_style', 'in', ['RAW', 'GPT'])
         | selectattr('location', 'search', regex_string)
         | list | first | default(none) %}
{%     set os_disk_id = matched_disk.unique_id if matched_disk else '' %}
{%     set current_partition_style = matched_disk.partition_style if matched_disk else 'NOT_FOUND' %}
{#
    SAP SPECIAL CASE: Always use drive letter S:\, never mount point
#}
{% if disktype == 'sap' %}
{%     set _ = pvlist.append({
         'diskname': 'SAP',
         'LUN': disk.LUN,
         'driveletter': 'S',
         'mount_point': none,
         'mount_base_path': none,
         'mount_folder_name': none,
         'sector_size': size,
         'disk_type': disktype,
         'osdisk_id': os_disk_id,
         'use_mount_point': false,
         'is_sap_disk': true,
         'current_partition_style': current_partition_style
       }) %}
{% elif use_mount_point %}
{#     Mount point strategy: disks mounted under folder paths #}
{%     if disktype == 'data' %}
{%         set _ = pvlist.append({
             'diskname': 'SQL' ~ disktype ~ data_disk_counter.value,
             'LUN': disk.LUN,
             'driveletter': none,
             'mount_point': mount_base_path_type ~ "\\" ~ mount_folder_name,
             'mount_base_path': mount_base_path_type,
             'mount_folder_name': mount_folder_name,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': true,
             'is_sap_disk': false,
             'current_partition_style': current_partition_style
           }) %}
{%     elif disktype == 'log' %}
{%         set _ = pvlist.append({
             'diskname': 'SQL' ~ disktype ~ log_disk_counter.value,
             'LUN': disk.LUN,
             'driveletter': none,
             'mount_point': mount_base_path_type ~ "\\" ~ mount_folder_name,
             'mount_base_path': mount_base_path_type,
             'mount_folder_name': mount_folder_name,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': true,
             'is_sap_disk': false,
             'current_partition_style': current_partition_style
           }) %}
{%     elif disktype == 'tempdb' %}
{%         set _ = pvlist.append({
             'diskname': 'SQL' ~ disktype ~ tempdb_disk_counter.value,
             'LUN': disk.LUN,
             'driveletter': none,
             'mount_point': mount_base_path_type ~ "\\" ~ mount_folder_name,
             'mount_base_path': mount_base_path_type,
             'mount_folder_name': mount_folder_name,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': true,
             'is_sap_disk': false,
             'current_partition_style': current_partition_style
           }) %}
{%     elif disktype == 'backup' %}
{%         set _ = pvlist.append({
             'diskname': disktype ~ backup_disk_counter.value,
             'LUN': disk.LUN,
             'driveletter': none,
             'mount_point': mount_base_path_type ~ "\\" ~ mount_folder_name,
             'mount_base_path': mount_base_path_type,
             'mount_folder_name': mount_folder_name,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': true,
             'is_sap_disk': false,
             'current_partition_style': current_partition_style
           }) %}
{%     else %}
{%         set _ = pvlist.append({
             'diskname': disktype ~ loop.index,
             'LUN': disk.LUN,
             'driveletter': none,
             'mount_point': mount_base_path_type ~ "\\" ~ mount_folder_name,
             'mount_base_path': mount_base_path_type,
             'mount_folder_name': mount_folder_name,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': true,
             'is_sap_disk': false,
             'current_partition_style': current_partition_style
           }) %}
{%     endif %}
{% else %}
{#     Drive letter strategy: traditional Windows drive letters (existing behavior) #}
{%     if disktype == 'data' %}
{%         set _ = pvlist.append({
             'diskname': 'SQL' ~ disktype ~ loop.index,
             'LUN': disk.LUN,
             'driveletter': startlettercharacter,
             'mount_point': none,
             'mount_base_path': none,
             'mount_folder_name': none,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': false,
             'is_sap_disk': false,
             'current_partition_style': current_partition_style
           }) %}
{%     elif disktype == 'log' %}
{%         set _ = pvlist.append({
             'diskname': 'SQL' ~ disktype ~ loop.index,
             'LUN': disk.LUN,
             'driveletter': startlettercharacter,
             'mount_point': none,
             'mount_base_path': none,
             'mount_folder_name': none,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': false,
             'is_sap_disk': false,
             'current_partition_style': current_partition_style
           }) %}
{%     elif disktype == 'tempdb' %}
{%         set _ = pvlist.append({
             'diskname': 'SQL' ~ disktype ~ loop.index,
             'LUN': disk.LUN,
             'driveletter': startlettercharacter,
             'mount_point': none,
             'mount_base_path': none,
             'mount_folder_name': none,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': false,
             'is_sap_disk': false,
             'current_partition_style': current_partition_style
           }) %}
{%     else %}
{%         set _ = pvlist.append({
             'diskname': disktype ~ loop.index,
             'LUN': disk.LUN,
             'driveletter': startlettercharacter,
             'mount_point': none,
             'mount_base_path': none,
             'mount_folder_name': none,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': false,
             'is_sap_disk': false,
             'current_partition_style': current_partition_style
           }) %}
{%     endif %}
{% endif %}
{%     endfor %}
{#
    Add sector_size and disk list to VG dictionary
    Note: '_' used as dummy variable that can be ignored
#}
{%     set _ = vg.update({'sector_size': size}) %}
{%     set _ = vg.update({'disks': pvlist}) %}
{#
    Append VG dictionary to list of VGs
    Note: '_' used as dummy variable that can be ignored
#}
{%     set _ = vgs.append(vg) %}
{% endfor %}
{#
    Output List of Dictionaries

    IMPORTANT: Output Python representation (not JSON) to handle undefined values
    The consumer (main.yml) loads this as volume_groups_config variable
#}
{{ pvlist }}
