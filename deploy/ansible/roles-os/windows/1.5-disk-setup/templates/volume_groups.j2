{# Copyright (c) Microsoft Corporation.
 # Licensed under the MIT License.
#}
{#
 # Windows Disk Volume Groups Template - Extended for Mount Point Support
 #
 # Purpose: Transform Azure disk configuration into Windows disk configuration
 #          Supports both drive letters and mount points
 #
 # Key Points:
 # - Azure LUN != Windows Disk Number (independent numbering)
 # - Matching via 'location' attribute with regex filter chains
 # - Handles undefined os_disk_id gracefully
 # - Outputs Python representation (not JSON) for undefined value compatibility
 #
 # Variables:
 # - disk_mount_strategy: 'driveletter' or 'mountpoint' (default: 'driveletter')
 # - disk_base_mount_path: Base path for mount points (default: 'C:\SQLServerDisks')
 #}
{% set vgs = [] %}
{#
    Initialize counters and common variables
#}
{%     set startletter = namespace(value=101) %}
{%     set data_disk_counter = namespace(value=0) %}
{%     set log_disk_counter = namespace(value=0) %}
{%     set tempdb_disk_counter = namespace(value=0) %}
{%     set backup_disk_counter = namespace(value=0) %}
{%     set pvlist = [] %}
{%     set use_mount_point = disk_mount_strategy | default('driveletter') == 'mountpoint' %}
{%     set base_mount_path = disk_base_mount_path | default('C:\\SQLServerDisks') %}
{#
    Outer Loop: Loop over disk types
#}
{% for disktype in disktypes %}
{#
    Initialize VG dictionary with VG name derived from disk type
#}
{%     set size = 4096 %}
{% if disktype == 'data' %}
{%     set size = 65536 %}
{% elif disktype == 'log' %}
{%     set size = 65536 %}
{% elif disktype == 'tempdb' %}
{%     set size = 65536 %}
{% endif %}
{%     set vg = {'disktype': disktype} %}
{#
    Inner Loop: Loop over list of disks that match the execution host and the disk type
#}
{%     for disk in disks if (disk.host == inventory_hostname) and (disk.type == disktype) %}
{%     set startletter.value = startletter.value + 1 %}
{%     set regex_string = '^Integrated.+LUN\s('~ disk.LUN ~ ')$' %}
{#
    Determine drive letter configuration based on disk type
#}
{% if disktype == 'sap' %}
{%     set startlettercharacter = "S" %}
{%     set mount_folder_name = "SAP" %}
{%     set mount_base_path = base_mount_path ~ "\\SAP" %}
{% elif disktype == 'log' %}
{%     set log_disk_counter.value = log_disk_counter.value + 1 %}
{%     set startlettercharacter = "N" %}
{%     set mount_folder_name = "LOG" ~ log_disk_counter.value %}
{%     set mount_base_path = base_mount_path ~ "\\LOG" %}
{% elif disktype == 'data' %}
{%     set data_disk_counter.value = data_disk_counter.value + 1 %}
{%     set startlettercharacter = "abcdefghijklmnopqrstuvwxyz"[startletter.value - 97] | upper %}
{%     set mount_folder_name = "DATA" ~ data_disk_counter.value %}
{%     set mount_base_path = base_mount_path ~ "\\DATA" %}
{% elif disktype == 'backup' %}
{%     set backup_disk_counter.value = backup_disk_counter.value + 1 %}
{%     set startlettercharacter = "T" %}
{%     set mount_folder_name = "BACKUP" ~ backup_disk_counter.value %}
{%     set mount_base_path = base_mount_path ~ "\\BACKUP" %}
{% elif disktype == 'tempdb' %}
{%     set tempdb_disk_counter.value = tempdb_disk_counter.value + 1 %}
{%     set startlettercharacter = "abcdefghijklmnopqrstuvwxyz"[startletter.value - 116] | upper %}
{%     set mount_folder_name = "TEMPDB" ~ tempdb_disk_counter.value %}
{%     set mount_base_path = base_mount_path ~ "\\TEMPDB" %}
{% else %}
{%     set startlettercharacter = "V" %}
{%     set mount_folder_name = disktype | upper ~ loop.index %}
{%     set mount_base_path = base_mount_path ~ "\\" ~ disktype | upper %}
{% endif %}
{#
    Disk Matching: Use proven filter chain pattern from production template
    - Uses 'location' attribute (flat, always available)
    - Filter chain handles nulls automatically
    - Returns undefined if no match (handled with default)
#}
{%     set os_disk_id = ansible_facts.disks | selectattr('location', 'match', regex_string) | rejectattr('partition_style', 'equalto', 'MBR') | map(attribute='unique_id') | list | first | default('') %}
{#
    Build disk configuration based on mount strategy
#}
{% if use_mount_point %}
{#     Mount point strategy: disks mounted under folder paths #}
{%     if disktype == 'data' %}
{%         set _ = pvlist.append({
             'diskname': 'SQL' ~ disktype ~ data_disk_counter.value,
             'LUN': disk.LUN,
             'driveletter': none,
             'mount_point': mount_base_path ~ "\\" ~ mount_folder_name,
             'mount_base_path': mount_base_path,
             'mount_folder_name': mount_folder_name,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': true
           }) %}
{%     elif disktype == 'log' %}
{%         set _ = pvlist.append({
             'diskname': 'SQL' ~ disktype ~ log_disk_counter.value,
             'LUN': disk.LUN,
             'driveletter': none,
             'mount_point': mount_base_path ~ "\\" ~ mount_folder_name,
             'mount_base_path': mount_base_path,
             'mount_folder_name': mount_folder_name,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': true
           }) %}
{%     elif disktype == 'tempdb' %}
{%         set _ = pvlist.append({
             'diskname': 'SQL' ~ disktype ~ tempdb_disk_counter.value,
             'LUN': disk.LUN,
             'driveletter': none,
             'mount_point': mount_base_path ~ "\\" ~ mount_folder_name,
             'mount_base_path': mount_base_path,
             'mount_folder_name': mount_folder_name,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': true
           }) %}
{%     elif disktype == 'backup' %}
{%         set _ = pvlist.append({
             'diskname': disktype ~ backup_disk_counter.value,
             'LUN': disk.LUN,
             'driveletter': none,
             'mount_point': mount_base_path ~ "\\" ~ mount_folder_name,
             'mount_base_path': mount_base_path,
             'mount_folder_name': mount_folder_name,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': true
           }) %}
{%     else %}
{%         set _ = pvlist.append({
             'diskname': disktype ~ loop.index,
             'LUN': disk.LUN,
             'driveletter': none,
             'mount_point': mount_base_path ~ "\\" ~ mount_folder_name,
             'mount_base_path': mount_base_path,
             'mount_folder_name': mount_folder_name,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': true
           }) %}
{%     endif %}
{% else %}
{#     Drive letter strategy: traditional Windows drive letters (existing behavior) #}
{%     if disktype == 'data' %}
{%         set _ = pvlist.append({
             'diskname': 'SQL' ~ disktype ~ loop.index,
             'LUN': disk.LUN,
             'driveletter': startlettercharacter,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': false
           }) %}
{%     elif disktype == 'log' %}
{%         set _ = pvlist.append({
             'diskname': 'SQL' ~ disktype ~ loop.index,
             'LUN': disk.LUN,
             'driveletter': startlettercharacter,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': false
           }) %}
{%     elif disktype == 'tempdb' %}
{%         set _ = pvlist.append({
             'diskname': 'SQL' ~ disktype ~ loop.index,
             'LUN': disk.LUN,
             'driveletter': startlettercharacter,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': false
           }) %}
{%     else %}
{%         set _ = pvlist.append({
             'diskname': disktype ~ loop.index,
             'LUN': disk.LUN,
             'driveletter': startlettercharacter,
             'sector_size': size,
             'disk_type': disktype,
             'osdisk_id': os_disk_id,
             'use_mount_point': false
           }) %}
{%     endif %}
{% endif %}
{%     endfor %}
{#
    Add sector_size and disk list to VG dictionary
    Note: '_' used as dummy variable that can be ignored
#}
{%     set _ = vg.update({'sector_size': size}) %}
{%     set _ = vg.update({'disks': pvlist}) %}
{#
    Append VG dictionary to list of VGs
    Note: '_' used as dummy variable that can be ignored
#}
{%     set _ = vgs.append(vg) %}
{% endfor %}
{#
    Output List of Dictionaries

    IMPORTANT: Output Python representation (not JSON) to handle undefined values
    The consumer (disks_config.yml) loads this as volume_groups variable
#}
{{ pvlist }}
