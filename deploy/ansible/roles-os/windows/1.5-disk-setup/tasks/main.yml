# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# /*---------------------------------------------------------------------------8
# |                                                                            |
# |                         OS Base Disk Configuration                         |
# |                                                                            |
# +------------------------------------4--------------------------------------*/
---
# -------------------------------------+---------------------------------------8
#
# Task: 1.5     disk-setup
#
# Description:  This role supports two disk mounting strategies:
#               1. Drive Letters - Traditional Windows drive letters
#               2. Mount Points - Mount disks under folder paths
#               3. Mixed Mode - Per-disk decision (e.g., SAP always uses S:\)
#
# Variables:
#   disk_mount_strategy: 'driveletter' or 'mountpoint' (default: 'driveletter')
#   disk_base_mount_path: Base path for mount points (default: 'C:\SQLServerDisks')
#
# Features:
#   - Idempotent: Can be run multiple times safely
#   - Recoverable: Handles partially-initialized disks
#   - SAP-aware: Always uses S:\ for SAP disks regardless of strategy
#
# Flow:
# NOT_FOUND → [FAIL if SAP disk, WARN otherwise]
#     ↓
#   RAW → Initialize → Format → Assign Drive Letter/Mount Point
#     ↓
# INITIALIZED_NO_PARTITION → Create Partition → Format → Assign
#     ↓
# NEEDS_DRIVE_LETTER → Remove old → Assign correct letter
#     ↓
# NEEDS_MOUNT_POINT → Remove old paths → Add correct mount point
#     ↓
# CONFIGURED → Skip (idempotent)
# -------------------------------------+---------------------------------------8


- name:                                "1.5 Disk setup - Get disk facts"
  community.windows.win_disk_facts:

- name:                                "1.5 Disk setup - Load the disk configuration settings"
  ansible.builtin.include_vars:
    file:                              "{{ role_path }}/vars/main.yml"
    name:                              disk_config_vars

- name:                                "1.5 Disk setup - Show disk configuration"
  ansible.builtin.debug:
    msg:
      - "Variables read into the task: {{ disk_config_vars }} "
      - "Unique disks:                 {{ disktypes }} "
      - "Volume groups count:          {{ volume_groups_config | length }} "
      - "Volume groups:                {{ volume_groups_config }}"
    verbosity:                         2

# ----------------------------------------
# Validation: Check for unmatched disks
# ----------------------------------------
- name:                                "1.5 Disk setup - Validate disk discovery"
  ansible.builtin.set_fact:
    unmatched_disks:                   "{{ volume_groups_config | selectattr('osdisk_id', 'equalto', '') | list }}"

- name:                                "1.5 Disk setup - Report unmatched disks"
  ansible.builtin.debug:
    msg:
      - "WARNING: {{ unmatched_disks | length }} disk(s) defined in inventory but not found on system:"
      - "{{ unmatched_disks | map(attribute='LUN') | list }}"
  when:                                unmatched_disks | length > 0

- name:                                "1.5 Disk setup - Fail if critical disks missing"
  ansible.builtin.fail:
    msg: |
      CRITICAL: SAP disk (LUN {{ item.LUN }}) not found on system.
      Expected disk at Azure LUN {{ item.LUN }} but no matching physical disk detected.
      Verify:
        1. Disk is attached to VM in Azure portal
        2. VM has been rebooted since disk attachment
        3. Disk is not already claimed by another system
  loop:                                "{{ unmatched_disks }}"
  when:
    - item.is_sap_disk | default(false)
  loop_control:
    label:                             "LUN {{ item.LUN }}"

# ----------------------------------------
# Mount Point : Create directory structure
# ----------------------------------------
- name:                                "1.5 Disk setup - Create directory structure - Mountpoint"
  when:
    - volume_groups_config | selectattr('use_mount_point', 'equalto', true) | list | length > 0
  block:
    - name:                            "1.5 Disk setup - Create base mount point directory"
      ansible.windows.win_file:
        path:                          "{{ hostvars[ansible_hostname]['disk_base_mount_path'] | default('C:\\SQLServerDisks') }}"
        state:                         directory

    - name:                            "1.5 Disk setup - Create top-level mount directories"
      when:
        - item.use_mount_point | default(false)
        - item.mount_base_path is not none
      ansible.windows.win_file:
        path:                          "{{ item.mount_base_path }}"
        state:                         directory
      loop:                            "{{ volume_groups_config }}"
      loop_control:
        label:                         "{{ item.mount_base_path | default(item.diskname) }}"

    - name:                            "1.5 Disk setup - Create disk-level mount directories"
      when:
        - item.use_mount_point | default(false)
        - item.mount_point is not none
      ansible.windows.win_file:
        path:                          "{{ item.mount_point }}"
        state:                         directory
      loop:                            "{{ volume_groups_config }}"
      loop_control:
        label:                         "{{ item.mount_point | default(item.diskname) }}"

# ----------------------------------------
# Disk State Detection (Unified)
# ----------------------------------------

- name:                                "1.5 Disk setup - Detect current disk state"
  when:
    - item.osdisk_id != ''
  ansible.windows.win_powershell:
    script: |
      $ErrorActionPreference = 'Stop'

      $diskId = "{{ item.osdisk_id }}"
      $useMountPoint = [System.Convert]::ToBoolean("{{ item.use_mount_point | default(false) | lower }}")
      $targetDrive = "{{ item.driveletter | default('') }}"
      $targetPath = "{{ item.mount_point | default('') }}"

      if ([string]::IsNullOrEmpty($diskId)) {
        Write-Output "NOT_FOUND"
        exit 0
      }

      try {
        $disk = Get-Disk | Where-Object { $_.UniqueId -eq $diskId }

        if (-not $disk) {
          Write-Output "NOT_FOUND"
          exit 0
        }

        if ($disk.PartitionStyle -eq 'RAW') {
          Write-Output "RAW"
          exit 0
        }

        $partitions = Get-Partition -DiskNumber $disk.Number -ErrorAction SilentlyContinue

        if (-not $partitions) {
          Write-Output "INITIALIZED_NO_PARTITION"
          exit 0
        }

        $isConfigured = $false

        if ($useMountPoint) {
          # Check for mount point
          foreach ($partition in $partitions) {
            foreach ($path in $partition.AccessPaths) {
              if ($path -eq $targetPath -or $path -eq ($targetPath + '\')) {
                $isConfigured = $true
                break
              }
            }
            if ($isConfigured) { break }
          }

          if ($isConfigured) {
            Write-Output "CONFIGURED"
          } else {
            Write-Output "NEEDS_MOUNT_POINT"
          }
        } else {
          # Check for drive letter
          foreach ($partition in $partitions) {
            if ($partition.DriveLetter -eq $targetDrive) {
              $isConfigured = $true
              break
            }
          }

          if ($isConfigured) {
            Write-Output "CONFIGURED"
          } else {
            Write-Output "NEEDS_DRIVE_LETTER"
          }
        }

      } catch {
        Write-Error "Error detecting disk state: $_"
        exit 1
      }
  loop:                                "{{ volume_groups_config }}"
  register:                            disk_states
  changed_when:                        false
  loop_control:
    label:                             "{{ item.diskname }} (LUN {{ item.LUN }})"

# ----------------------------------------
# Drive Letter: Initialization and Fix
# ----------------------------------------
- name:                                "1.5 Disk setup - Drive letter disk operations"
  when:
    - volume_groups_config | rejectattr('use_mount_point', 'equalto', true) | list | length > 0
  block:
    - name:                            "1.5 Disk setup - Initialize RAW disks (drive letter)"
      when:
        - not item.item.use_mount_point | default(false)
        - item.item.osdisk_id != ''
        - item.output is defined
        - item.output[0] | default('') | trim == 'RAW'
        - item.skipped is not defined or not item.skipped
      ansible.windows.win_powershell:
        script: |
          $ErrorActionPreference = 'Stop'

          $diskId = "{{ item.item.osdisk_id }}"
          $driveLetter = "{{ item.item.driveletter }}"
          $diskName = "{{ item.item.diskname }}"
          $allocationSize = {{ item.item.sector_size }}

          $disk = Get-Disk | Where-Object { $_.UniqueId -eq $diskId }

          if ($disk.PartitionStyle -eq 'RAW') {
            Initialize-Disk -Number $disk.Number -PartitionStyle GPT
          }

          $partition = New-Partition -DiskNumber $disk.Number -UseMaximumSize -DriveLetter $driveLetter

          Format-Volume -DriveLetter $driveLetter `
                        -FileSystem NTFS `
                        -NewFileSystemLabel $diskName `
                        -AllocationUnitSize $allocationSize `
                        -Confirm:$false

          Write-Output "INITIALIZED: ${driveLetter}:"
      loop:                            "{{ disk_states.results | default([]) }}"
      loop_control:
        label:                         "{{ item.item.diskname }} -> {{ item.item.driveletter }}:"
      register:                        win_disk_driveletter_init_raw

    - name:                            "1.5 Disk setup - Create partition on initialized disks (drive letter)"
      when:
        - not item.item.use_mount_point | default(false)
        - item.item.osdisk_id != ''
        - item.output is defined
        - item.output[0] | default('') | trim == 'INITIALIZED_NO_PARTITION'
        - item.skipped is not defined or not item.skipped
      ansible.windows.win_powershell:
        script: |
          $ErrorActionPreference = 'Stop'

          $diskId = "{{ item.item.osdisk_id }}"
          $driveLetter = "{{ item.item.driveletter }}"
          $diskName = "{{ item.item.diskname }}"
          $allocationSize = {{ item.item.sector_size }}

          $disk = Get-Disk | Where-Object { $_.UniqueId -eq $diskId }

          $partition = New-Partition -DiskNumber $disk.Number -UseMaximumSize -DriveLetter $driveLetter

          Format-Volume -DriveLetter $driveLetter `
                        -FileSystem NTFS `
                        -NewFileSystemLabel $diskName `
                        -AllocationUnitSize $allocationSize `
                        -Confirm:$false

          Write-Output "CONFIGURED: ${driveLetter}:"
      loop:                            "{{ disk_states.results | default([]) }}"
      loop_control:
        label:                         "{{ item.item.diskname }} -> {{ item.item.driveletter }}:"
      register:                        win_disk_driveletter_init_nopart

    - name:                            "1.5 Disk setup - Fix drive letter on misconfigured disks"
      when:
        - not item.item.use_mount_point | default(false)
        - item.item.osdisk_id != ''
        - item.output is defined
        - item.output[0] | default('') | trim == 'NEEDS_DRIVE_LETTER'
        - item.skipped is not defined or not item.skipped
      ansible.windows.win_powershell:
        script: |
          $ErrorActionPreference = 'Stop'

          $diskId = "{{ item.item.osdisk_id }}"
          $targetDrive = "{{ item.item.driveletter }}"

          $disk = Get-Disk | Where-Object { $_.UniqueId -eq $diskId }
          $partition = Get-Partition -DiskNumber $disk.Number |
                       Where-Object { $_.Type -eq 'Basic' } |
                       Select-Object -First 1

          if ($partition) {
            if ($partition.DriveLetter) {
              Remove-PartitionAccessPath -DiskNumber $disk.Number `
                                         -PartitionNumber $partition.PartitionNumber `
                                         -AccessPath "$($partition.DriveLetter):" `
                                         -ErrorAction SilentlyContinue
            }

            Set-Partition -DiskNumber $disk.Number `
                          -PartitionNumber $partition.PartitionNumber `
                          -NewDriveLetter $targetDrive

            Write-Output "FIXED: Drive letter ${targetDrive}:"
          } else {
            Write-Error "No suitable partition found on disk"
            exit 1
          }
      loop:                            "{{ disk_states.results | default([]) }}"
      loop_control:
        label:                         "{{ item.item.diskname }} -> {{ item.item.driveletter }}:"
      register:                        win_disk_driveletter_fix

# ----------------------------------------
# Mount Point: Initialization and Fix
# ----------------------------------------
- name:                                "1.5 Disk setup - Mount point disk operations"
  when:
    - volume_groups_config | selectattr('use_mount_point', 'equalto', true) | list | length > 0
  block:
    - name:                            "1.5 Disk setup - Initialize RAW disks (mount point)"
      when:
        - item.item.use_mount_point | default(false)
        - item.item.osdisk_id != ''
        - item.output is defined
        - item.output[0] | default('') | trim == 'RAW'
        - item.skipped is not defined or not item.skipped
      ansible.windows.win_powershell:
        script: |
          $ErrorActionPreference = 'Stop'

          $diskId = "{{ item.item.osdisk_id }}"
          $diskName = "{{ item.item.diskname }}"
          $targetPath = "{{ item.item.mount_point }}"
          $allocationSize = {{ item.item.sector_size }}

          $disk = Get-Disk | Where-Object { $_.UniqueId -eq $diskId }

          if ($disk.PartitionStyle -eq 'RAW') {
            Initialize-Disk -Number $disk.Number -PartitionStyle GPT
          }

          $partition = New-Partition -DiskNumber $disk.Number -UseMaximumSize

          Format-Volume -Partition $partition `
                        -FileSystem NTFS `
                        -NewFileSystemLabel $diskName `
                        -AllocationUnitSize $allocationSize `
                        -Confirm:$false

          Add-PartitionAccessPath -DiskNumber $disk.Number `
                                  -PartitionNumber $partition.PartitionNumber `
                                  -AccessPath $targetPath

          Write-Output "INITIALIZED: $targetPath"
      loop:                            "{{ disk_states.results | default([]) }}"
      loop_control:
        label:                         "{{ item.item.diskname }} -> {{ item.item.mount_point | default('N/A') }}"
      register:                        win_disk_mountpoint_init_raw

    - name:                            "1.5 Disk setup - Create partition on initialized disks (mount point)"
      when:
        - item.item.use_mount_point | default(false)
        - item.item.osdisk_id != ''
        - item.output is defined
        - item.output[0] | default('') | trim == 'INITIALIZED_NO_PARTITION'
        - item.skipped is not defined or not item.skipped
      ansible.windows.win_powershell:
        script: |
          $ErrorActionPreference = 'Stop'

          $diskId = "{{ item.item.osdisk_id }}"
          $diskName = "{{ item.item.diskname }}"
          $targetPath = "{{ item.item.mount_point }}"
          $allocationSize = {{ item.item.sector_size }}

          $disk = Get-Disk | Where-Object { $_.UniqueId -eq $diskId }

          $partition = Get-Partition -DiskNumber $disk.Number -ErrorAction SilentlyContinue |
                       Where-Object { $_.Type -eq 'Basic' } |
                       Select-Object -First 1

          if (-not $partition) {
            $partition = New-Partition -DiskNumber $disk.Number -UseMaximumSize
            Format-Volume -Partition $partition `
                          -FileSystem NTFS `
                          -NewFileSystemLabel $diskName `
                          -AllocationUnitSize $allocationSize `
                          -Confirm:$false
          }

          $existingPaths = $partition.AccessPaths
          $hasMount = $false
          foreach ($path in $existingPaths) {
            if ($path -eq $targetPath -or $path -eq ($targetPath + '\')) {
              $hasMount = $true
              break
            }
          }

          if (-not $hasMount) {
            Add-PartitionAccessPath -DiskNumber $disk.Number `
                                    -PartitionNumber $partition.PartitionNumber `
                                    -AccessPath $targetPath
            Write-Output "CONFIGURED: $targetPath"
          } else {
            Write-Output "ALREADY_MOUNTED: $targetPath"
          }
      loop:                            "{{ disk_states.results | default([]) }}"
      loop_control:
        label:                         "{{ item.item.diskname }} -> {{ item.item.mount_point | default('N/A') }}"
      register:                        win_disk_mountpoint_init

    - name:                            "1.5 Disk setup - Fix mount point on misconfigured disks"
      when:
        - item.item.use_mount_point | default(false)
        - item.item.osdisk_id != ''
        - item.output is defined
        - item.output[0] | default('') | trim == 'NEEDS_MOUNT_POINT'
        - item.skipped is not defined or not item.skipped
      ansible.windows.win_powershell:
        script: |
          $ErrorActionPreference = 'Stop'

          $diskId = "{{ item.item.osdisk_id }}"
          $targetPath = "{{ item.item.mount_point }}"

          $disk = Get-Disk | Where-Object { $_.UniqueId -eq $diskId }
          $partition = Get-Partition -DiskNumber $disk.Number |
                       Where-Object { $_.Type -eq 'Basic' } |
                       Select-Object -First 1

          if ($partition) {
            foreach ($path in $partition.AccessPaths) {
              if ($path -ne $targetPath -and $path -ne ($targetPath + '\')) {
                Remove-PartitionAccessPath -DiskNumber $disk.Number `
                                           -PartitionNumber $partition.PartitionNumber `
                                           -AccessPath $path `
                                           -ErrorAction SilentlyContinue
              }
            }

            Add-PartitionAccessPath -DiskNumber $disk.Number `
                                    -PartitionNumber $partition.PartitionNumber `
                                    -AccessPath $targetPath

            Write-Output "FIXED: Mount point $targetPath"
          } else {
            Write-Error "No suitable partition found on disk"
            exit 1
          }
      loop:                            "{{ disk_states.results | default([]) }}"
      loop_control:
        label:                         "{{ item.item.diskname }} -> {{ item.item.mount_point | default('N/A') }}"
      register:                        win_disk_mountpoint_fix

# ----------------------------------------
# Verification
# ----------------------------------------
- name:                                "1.5 Disk setup - Verify final disk configuration"
  ansible.windows.win_powershell:
    script: |
      $ErrorActionPreference = 'Stop'

      $diskId = "{{ item.item.osdisk_id }}"
      $useMountPoint = [System.Convert]::ToBoolean("{{ item.item.use_mount_point | default(false) | lower }}")

      $disk = Get-Disk | Where-Object { $_.UniqueId -eq $diskId }

      if (-not $disk) {
        Write-Output "ERROR: Disk not found"
        exit 1
      }

      $partitions = Get-Partition -DiskNumber $disk.Number -ErrorAction SilentlyContinue

      if (-not $partitions) {
        Write-Output "ERROR: No partitions on disk"
        exit 1
      }

      $verified = $false

      if ($useMountPoint) {
        $targetPath = "{{ item.item.mount_point }}"

        foreach ($partition in $partitions) {
          foreach ($path in $partition.AccessPaths) {
            if ($path -eq $targetPath -or $path -eq ($targetPath + '\')) {
              Write-Output "SUCCESS: Mount point $targetPath configured"
              $verified = $true
              break
            }
          }
          if ($verified) { break }
        }

        if (-not $verified) {
          Write-Output "ERROR: Mount point not configured correctly"
          exit 1
        }
      } else {
        $targetDrive = "{{ item.item.driveletter }}"

        foreach ($partition in $partitions) {
          if ($partition.DriveLetter -eq $targetDrive) {
            Write-Output "SUCCESS: Drive letter ${targetDrive}: configured"
            $verified = $true
            break
          }
        }

        if (-not $verified) {
          Write-Output "ERROR: Drive letter not configured correctly"
          exit 1
        }
      }
  loop:                                "{{ disk_states.results | default([]) }}"
  when:
    - item.item.osdisk_id != ''
    - item.output is defined
    - item.skipped is not defined or not item.skipped
  register:                            disk_verification
  changed_when:                        false
  failed_when:                         false
  loop_control:
    label:                             "{{ item.item.diskname }}"

- name:                                "1.5 Disk setup - Show verification results"
  ansible.builtin.debug:
    msg:
      - "Disk: {{ item.item.item.diskname }}"
      - "Status: {{ item.output[0] | default('UNKNOWN') }}"
    verbosity:                         1
  loop:                                "{{ disk_verification.results | default([]) }}"
  when:
    - item.output is defined
    - item.skipped is not defined or not item.skipped
  loop_control:
    label:                             "{{ item.item.item.diskname }}"

- name:                                "1.5 Disk setup - Report configuration failures"
  ansible.builtin.fail:
    msg: |
      Disk configuration verification failed for {{ item.item.item.diskname }}:
      {{ item.output[0] | default('UNKNOWN') }}

      Manual intervention may be required to resolve disk configuration issues.
  loop:                                "{{ disk_verification.results | default([]) }}"
  when:
    - item.output is defined
    - item.output[0] | default('') is search('ERROR')
    - item.skipped is not defined or not item.skipped
  loop_control:
    label:                             "{{ item.item.item.diskname }}"

...
# /*---------------------------------------------------------------------------8
# |                                   END                                      |
# +------------------------------------4--------------------------------------*/
