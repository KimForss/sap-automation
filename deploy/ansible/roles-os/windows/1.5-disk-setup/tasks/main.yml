# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# /*---------------------------------------------------------------------------8
# |                                                                            |
# |                         OS Base Disk Configuration                         |
# |                                                                            |
# +------------------------------------4--------------------------------------*/
---
# -------------------------------------+---------------------------------------8
#
# Task: 1.5     disk-setup
#
# Description:  This role supports two disk mounting strategies:
#               1. Drive Letters - Traditional Windows drive letters
#               2. Mount Points - Mount disks under folder paths
#
# Variables:
#   disk_mount_strategy: 'driveletter' or 'mountpoint' (default: 'driveletter')
#   disk_base_mount_path: Base path for mount points (default: 'C:\SQLServerDisks')
#
# -------------------------------------+---------------------------------------8

- name:                                "1.5 Disk setup - Set default mount strategy"
  ansible.builtin.set_fact:
    disk_mount_strategy:               "{{ hostvars[ansible_hostname]['disk_mount_strategy'] | default('driveletter') }}"
    disk_base_mount_path:              "{{ hostvars[ansible_hostname]['disk_base_mount_path'] | default('C:\\SQLServerDisks') }}"

- name:                                "1.5 Disk setup - Get disk facts"
  community.windows.win_disk_facts:

- name:                                "1.5 Disk setup - Show disk info from facts"
  ansible.builtin.debug:
    msg:
      - "Disks:                        {{ ansible_facts.disks }} "
      - "Mount Strategy:               {{ disk_mount_strategy }}"
      - "Base Mount Path:              {{ disk_base_mount_path }}"
    verbosity:                         2

- name:                                "1.5 Disk setup - Load the disk configuration settings"
  ansible.builtin.include_vars:
    file:                              "{{ role_path }}/vars/main.yml"
    name:                              disk_config_vars

- name:                                "[DEBUG] 1.5 Disk setup - Show loaded disk configuration variables"
  ansible.builtin.debug:
    var:                               disk_config_vars
    verbosity:                         2

- name:                                "1.5 Disk setup - Show disk configuration"
  ansible.builtin.debug:
    msg:
      - "Unique disks:                 {{ disktypes }} "
      - "Volume groups count:          {{ volume_groups | length }} "
      - "Volume groups:                {{ volume_groups }}"
    verbosity:                         2

# ----------------------------------------
# Mount Point : Create directory structure
# ----------------------------------------
- name:                                "1.5 Disk setup - Create directory structure - Mountpoint"
  when:
                                       - hostvars[ansible_hostname]['disk_mount_strategy'] is defined
                                       - hostvars[ansible_hostname]['disk_mount_strategy'] == 'mountpoint' | bool
  block:
    - name:                            "1.5 Disk setup - Create base mount point directory"
      ansible.windows.win_file:
        path:                          "{{ disk_base_mount_path }}"
        state:                         directory

    - name:                            "1.5 Disk setup - Create top-level mount directories"
      when:
                                       - item.use_mount_point | default(false)
      ansible.windows.win_file:
        path:                          "{{ item.mount_base_path }}"
        state:                         directory
      loop:                            "{{ volume_groups }}"
      loop_control:
        label:                         "{{ item.mount_base_path }}"

    - name:                            "1.5 Disk setup - Create disk-level mount directories"
      when:
                                       - item.use_mount_point | default(false)
      ansible.windows.win_file:
        path:                          "{{ item.mount_point }}"
        state:                         directory
      loop:                            "{{ volume_groups }}"
      loop_control:
        label:                         "{{ item.mount_point }}"

# ----------------------------------------
# Disk Initialization
# ----------------------------------------

- name:                                "1.5 Disk setup - Wait for disks to be available"
  when:                                item.osdisk_id != ''
  ansible.windows.win_dsc:
    resource_name:                     "WaitForDisk"
    DiskId:                            "{{ item.osdisk_id }}"
    DiskIdType:                        'UniqueId'
    RetryIntervalSec:                  60
    RetryCount:                        10
  loop:                                "{{ volume_groups }}"
  loop_control:
    label:                             "{{ item.diskname }} (LUN {{ item.LUN }})"

# ----------------------------------------
# Drive Letter : Use DriveLetter parameter
# ----------------------------------------
- name:                                "1.5 Disk setup - Disk initialization with - DriveLetter"
  when:
                                       - hostvars[ansible_hostname]['disk_mount_strategy'] is defined
                                       - hostvars[ansible_hostname]['disk_mount_strategy'] == 'driveletter' | bool
  block:

    - name:                            "1.5 Disk setup - Initialize disks with drive letters"
      when:
                                       - not item.use_mount_point | default(false)
                                       - item.osdisk_id != ''
      ansible.windows.win_dsc:
        resource_name:                 "Disk"
        DiskId:                        "{{ item.osdisk_id }}"
        DiskIdType:                    'UniqueId'
        DriveLetter:                   "{{ item.driveletter }}"
        PartitionStyle:                "GPT"
        FSLabel:                       "{{ item.diskname }}"
        FSFormat:                      'NTFS'
        AllocationUnitSize:            "{{ item.sector_size }}"
      loop:                            "{{ volume_groups }}"
      loop_control:
        label:                         "{{ item.diskname }} -> {{ item.driveletter }}:"
      register:                        win_disk_driveletter_results

# ----------------------------------------
# Mount Point : Use AccessPath parameter
# ----------------------------------------

# TODO: Upgrade to StorageDSC 6.1.0 or later to use the native AccessPath parameter
#       Currently the StorageDSC module 6.1.0 is in preview.
# - name: "1.4-Packages: Ensure DSC modules are installed"
#   ansible.windows.win_psmodule:
#    name:                               StorageDsc
#    state:                              present
#    required_version:                   "6.1.0"  # or minimum_version: "6.1.0"
#
# - name:                                "1.5 Disk setup - Initialize disks with mount points"
#   when:
#                                        - disk_mount_strategy == 'mountpoint'
#                                        - item.use_mount_point | default(false)
#                                        - item.osdisk_id != ''
#   ansible.windows.win_dsc:
#     resource_name:                     "Disk"
#     DiskId:                            "{{ item.osdisk_id }}"
#     DiskIdType:                        'UniqueId'
#     AccessPath:                        "{{ item.mount_point }}"
#     PartitionStyle:                    "GPT"
#     FSLabel:                           "{{ item.diskname }}"
#     FSFormat:                          'NTFS'
#     AllocationUnitSize:                "{{ item.sector_size }}"
#   loop:                                "{{ volume_groups }}"
#   loop_control:
#     label:                             "{{ item.diskname }} -> {{ item.mount_point }}"
#   register:                            win_disk_mountpoint_results

- name:                                "1.5 Disk setup - Disk initialization with - MountPoint"
  when:
                                       - hostvars[ansible_hostname]['disk_mount_strategy'] is defined
                                       - hostvars[ansible_hostname]['disk_mount_strategy'] == 'mountpoint' | bool
  block:
    - name:                            "1.5 Disk setup - Initialize and mount disks with PowerShell"
      when:
                                       - disk_mount_strategy == 'mountpoint'
                                       - item.use_mount_point | default(false)
                                       - item.osdisk_id != ''
      ansible.windows.win_powershell:
        script: |
                                       $ErrorActionPreference = 'Stop'

                                       $disk = Get-Disk | Where-Object { $_.UniqueId -eq '{{ item.osdisk_id }}' }

                                       if ($disk.PartitionStyle -eq 'RAW') {
                                         Initialize-Disk -Number $disk.Number -PartitionStyle GPT
                                         $partition = New-Partition -DiskNumber $disk.Number -UseMaximumSize
                                         Format-Volume -Partition $partition -FileSystem NTFS -NewFileSystemLabel '{{ item.diskname }}' -AllocationUnitSize {{ item.sector_size }} -Confirm:$false
                                         Add-PartitionAccessPath -DiskNumber $disk.Number -PartitionNumber $partition.PartitionNumber -AccessPath '{{ item.mount_point }}'
                                       }
      loop:                            "{{ volume_groups }}"
      loop_control:
        label:                         "{{ item.diskname }} -> {{ item.mount_point }}"
      register:                        win_disk_mountpoint_results

# ----------------------------------------
# Debug output
# ----------------------------------------
- name:                                "1.5 Disk setup - Show disk initialization results"
  when:                                hostvars[ansible_hostname]['disk_mount_strategy'] is defined
  block:
    - name:                            "1.5 Disk setup - Show disk initialization results (drive letters)"
      when:
                                       - hostvars[ansible_hostname]['disk_mount_strategy'] == 'driveletter' | bool
                                       - win_disk_driveletter_results is defined
      ansible.builtin.debug:
        msg:
          - "Drive letter results:     {{ win_disk_driveletter_results }}"
        verbosity:                     2

    - name:                            "1.5 Disk setup - Show disk initialization results (mount points)"
      when:
                                       - hostvars[ansible_hostname]['disk_mount_strategy'] == 'mountpoint' | bool
                                       - win_disk_mountpoint_results is defined
      ansible.builtin.debug:
        msg:
          - "Mount point results:      {{ win_disk_mountpoint_results }}"
        verbosity:                     2

...
# /*---------------------------------------------------------------------------8
# |                                   END                                      |
# +------------------------------------4--------------------------------------*/
