# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# /*---------------------------------------------------------------------------8
# |                                                                            |
# |                         OS Base Disk Configuration                         |
# |                                                                            |
# +------------------------------------4--------------------------------------*/
---
# -------------------------------------+---------------------------------------8
#
# Task: 1.5     disk-setup
#
# Description:  This role supports two disk mounting strategies:
#               1. Drive Letters - Traditional Windows drive letters
#               2. Mount Points - Mount disks under folder paths
#
# Variables:
#   disk_mount_strategy: 'driveletter' or 'mountpoint' (default: 'driveletter')
#   disk_base_mount_path: Base path for mount points (default: 'C:\SQLServerDisks')
#
# -------------------------------------+---------------------------------------8

- name:                                "1.5 Disk setup - Set default mount strategy"
  ansible.builtin.set_fact:
    disk_mount_strategy:               "{{ disk_mount_strategy | default('driveletter') }}"
    disk_base_mount_path:              "{{ disk_base_mount_path | default('C:\\SQLServerDisks') }}"

- name:                                "1.5 Disk setup - Get disk facts"
  community.windows.win_disk_facts:

- name:                                "1.5 Disk setup - Show disk info from facts"
  ansible.builtin.debug:
    msg:
      - "Disks:                        {{ ansible_facts.disks }} "
      - "Mount Strategy:               {{ disk_mount_strategy }}"
      - "Base Mount Path:              {{ disk_base_mount_path }}"
    verbosity:                         2

- name:                                "1.5 Disk setup - Load the disk configuration settings"
  ansible.builtin.include_vars:
    file:                              "{{ role_path }}/vars/main.yml"
    name:                              disk_config_vars

- name:                                "[DEBUG] 1.5 Disk setup - Show loaded disk configuration variables"
  ansible.builtin.debug:
    var:                               disk_config_vars
    verbosity:                         2

- name:                                "1.5 Disk setup - Show disk configuration"
  ansible.builtin.debug:
    msg:
      - "Unique disks:                 {{ disktypes }} "
      - "Volume groups count:          {{ volume_groups | length }} "
      - "Volume groups:                {{ volume_groups }}"
    verbosity:                         2

# ----------------------------------------
# Mount Point Strategy: Create directory structure
# ----------------------------------------

- name:                                "1.5 Disk setup - Create base mount point directory"
  when:
    - disk_mount_strategy == 'mountpoint'
  ansible.windows.win_file:
    path:                              "{{ disk_base_mount_path }}"
    state:                             directory

- name:                                "1.5 Disk setup - Create type-level mount directories"
  when:
    - disk_mount_strategy == 'mountpoint'
    - item.use_mount_point | default(false)
  ansible.windows.win_file:
    path:                              "{{ item.mount_base_path }}"
    state:                             directory
  loop:                                "{{ volume_groups }}"
  loop_control:
    label:                             "{{ item.mount_base_path }}"

- name:                                "1.5 Disk setup - Create disk-level mount directories"
  when:
    - disk_mount_strategy == 'mountpoint'
    - item.use_mount_point | default(false)
  ansible.windows.win_file:
    path:                              "{{ item.mount_point }}"
    state:                             directory
  loop:                                "{{ volume_groups }}"
  loop_control:
    label:                             "{{ item.mount_point }}"

# ----------------------------------------
# Disk Initialization (both strategies)
# ----------------------------------------

- name:                                "1.5 Disk setup - Wait for disks to be available"
  ansible.windows.win_dsc:
    resource_name:                     "WaitForDisk"
    DiskId:                            "{{ item.osdisk_id }}"
    DiskIdType:                        'UniqueId'
    RetryIntervalSec:                  60
    RetryCount:                        10
  loop:                                "{{ volume_groups }}"
  loop_control:
    label:                             "{{ item.diskname }} (LUN {{ item.LUN }})"
  when:                                item.osdisk_id != ''

# ----------------------------------------
# Drive Letter Strategy: Use DriveLetter parameter
# ----------------------------------------

- name:                                "1.5 Disk setup - Initialize disks with drive letters"
  when:
    - disk_mount_strategy == 'driveletter'
    - not item.use_mount_point | default(false)
    - item.osdisk_id != ''
  ansible.windows.win_dsc:
    resource_name:                     "Disk"
    DiskId:                            "{{ item.osdisk_id }}"
    DiskIdType:                        'UniqueId'
    DriveLetter:                       "{{ item.driveletter }}"
    PartitionStyle:                    "GPT"
    FSLabel:                           "{{ item.diskname }}"
    FSFormat:                          'NTFS'
    AllocationUnitSize:                "{{ item.sector_size }}"
  loop:                                "{{ volume_groups }}"
  loop_control:
    label:                             "{{ item.diskname }} -> {{ item.driveletter }}:"
  register:                            win_disk_driveletter_results

# ----------------------------------------
# Mount Point Strategy: Use AccessPath parameter
# ----------------------------------------

- name:                                "1.5 Disk setup - Initialize disks with mount points"
  when:
    - disk_mount_strategy == 'mountpoint'
    - item.use_mount_point | default(false)
    - item.osdisk_id != ''
  ansible.windows.win_dsc:
    resource_name:                     "Disk"
    DiskId:                            "{{ item.osdisk_id }}"
    DiskIdType:                        'UniqueId'
    AccessPath:                        "{{ item.mount_point }}"
    PartitionStyle:                    "GPT"
    FSLabel:                           "{{ item.diskname }}"
    FSFormat:                          'NTFS'
    AllocationUnitSize:                "{{ item.sector_size }}"
  loop:                                "{{ volume_groups }}"
  loop_control:
    label:                             "{{ item.diskname }} -> {{ item.mount_point }}"
  register:                            win_disk_mountpoint_results

# ----------------------------------------
# Debug output
# ----------------------------------------

- name:                               "1.5 Disk setup - Show disk initialization results (drive letters)"
  when:
    - disk_mount_strategy == 'driveletter'
    - win_disk_driveletter_results is defined
  ansible.builtin.debug:
    msg:
      - "Drive letter results:         {{ win_disk_driveletter_results }}"
    verbosity:                        2

- name:                               "1.5 Disk setup - Show disk initialization results (mount points)"
  when:
    - disk_mount_strategy == 'mountpoint'
    - win_disk_mountpoint_results is defined
  ansible.builtin.debug:
    msg:
      - "Mount point results:          {{ win_disk_mountpoint_results }}"
    verbosity:                        2

...
# /*---------------------------------------------------------------------------8
# |                                   END                                      |
# +------------------------------------4--------------------------------------*/
